Interactively exploring the quantities of solar wind.

## Data

- [PSP/FIELDS Level 2 and higher data](https://fields.ssl.berkeley.edu/data/), [SPDF - Coordinated Data Analysis Web (CDAWeb)](https://cdaweb.gsfc.nasa.gov/cgi-bin/eval2.cgi?dataset=PSP_FLD_L2_MAG_RTN&index=sp_phys)

WI_H1_SWE	Proton_W_moment	        Proton thermal speed W (km/s) from isotropic moment analysis
WI_H1_SWE	Proton_Wperp_moment 	Proton thermal speed Wperpendicular (km/s) from bimax moment analysis
WI_H1_SWE	Proton_Wpar_moment	    Proton thermal speed Wparallel (km/s) from bimax moment analysis

WI_H1_SWE	Proton_Wperp_nonlin	    Proton thermal speed perpendicular to the magnetic field direction [km/s].
WI_H1_SWE	Proton_Wpar_nonlin	    Proton thermal speed parallel to the magnetic field direction [km/s].

Notes: `thb_peim_t3_magQ` is not accurate in solar wind mode.

## Overview

```{julia}
using Speasy
using SPEDAS
using SPEDAS: ulabel, smooth
using DimensionalData
using GLMakie
using Statistics
# using CairoMakie
using Dates
using PartialFunctions
using Unitful
using Beforerr: _theme_legend
using SPEDAS.SpaceDataModel: set
include("../src/psp_temp.jl")

update_theme!(_theme_legend(; padding=(0, 0, 0, 0)))
```

```{julia}
# along time get the temperature from anisotropic temperature
function tTemp(x; dims=Ti)
    return mean.(eachslice(x; dims))
end

_unitify(u) = x -> x * u
mva_transform((V, B), tmin, tmax) = mva(V(tmin, tmax), B(tmin, tmax))
```


```{julia}
tmin_psp = DateTime("2021-01-14")
tmax_psp = DateTime("2021-01-21")
tmin_wind = DateTime("2021-01-17")
tmax_wind = DateTime("2021-01-23")

tmin_psp = DateTime("2021-01-16")
tmax_psp = DateTime("2021-01-19")
tmin_wind = DateTime("2021-01-17")
tmax_wind = DateTime("2021-01-18")

B_ylabel = "B (nT)"
B_labels = ["Bx", "By", "Bz", "Magnitude"]
n_ylabel = ulabel("Density", "cm^-3")
V_ylabel = "Velocity (km/s)"
V_labels = ["Vx", "Vy", "Vz", "Magnitude"]
Temp_ylabel = "Temperature (eV)"
WI_PM_3DP_labels = ["Proton"] # "Proton (3DP, PESA Low)"
WI_ELM2_3DP_labels = ["Electron"] # "Electron (3DP, EESA Low)"

mva_V_labels = ["V_L", "V_M", "V_N"]
```

```{julia}
psp_B = SpeasyProduct("PSP_FLD_L2_MAG_RTN_4_SA_PER_CYC/psp_fld_l2_mag_RTN_4_Sa_per_Cyc"; ylabel=B_ylabel, labels=B_labels)

psp_n = SPEDAS.DataSet(
    "Density",
    [
        SpeasyProduct("PSP_SWP_SPI_SF00_L3_MOM/DENS"; labels=["SPI Proton"]),
        _unitify(u"cm^-3") ∘ SpeasyProduct("PSP_SWP_SPC_L3I/np_moment"; labels=["SPC Proton"]),
        SpeasyProduct("PSP_FLD_L3_RFS_LFR_QTN/N_elec"; labels=["RFS Electron"]),
        SpeasyProduct("PSP_FLD_L3_SQTN_RFS_V1V2/electron_density"; labels=["SQTN Electron"])
    ];
    ylabel=n_ylabel
)

psp_temp = SPEDAS.DataSet(
    "Temperature",
    [
        SpeasyProduct("PSP_SWP_SPI_SF00_L3_MOM/TEMP"; labels=["SPI Proton"]),
        smooth(30u"s") ∘ SpeasyProduct("PSP_FLD_L3_SQTN_RFS_V1V2/electron_core_temperature"; labels=["SQTN Electron core"]),
    ];
    ylabel=Temp_ylabel
)

psp_V = SpeasyProduct("PSP_SWP_SPI_SF00_L3_MOM/VEL_RTN_SUN"; ylabel=V_ylabel, labels=V_labels)

tvars_psp = [
    tnorm_combine ∘ psp_B,
    psp_n,
    psp_V,
    psp_temp
]
```

```{julia}
wind_n = SPEDAS.DataSet(
    "Density",
    [
        SpeasyProduct("WI_PM_3DP/P_DENS"; labels=WI_PM_3DP_labels),
        SpeasyProduct("WI_ELM2_3DP/DENSITY"; labels=WI_ELM2_3DP_labels)
    ];
    ylabel=n_ylabel
)

wind_temp = SPEDAS.DataSet(
    "Temperature",
    [
        SpeasyProduct("WI_PM_3DP/P_TEMP"; labels=WI_PM_3DP_labels),
        SpeasyProduct("WI_ELM2_3DP/AVGTEMP"; labels=WI_ELM2_3DP_labels),
    ];
    ylabel=Temp_ylabel
)

tvars_wind = [
    tnorm_combine ∘ SpeasyProduct("WI_H3-RTN_MFI/BRTN"; ylabel=B_ylabel, labels=B_labels),
    wind_n,
    tsubtract ∘ SpeasyProduct("WI_K0_SWE_RTN/V_RTN"; ylabel=V_ylabel, labels=V_labels),
    wind_temp
]
```

```{julia}
thm_temp = SPEDAS.DataSet(
    "Temperature",
    [
        "THB_L2_ESA/thb_peif_avgtempQ",
        tTemp ∘ SpeasyProduct("THB_L2_MOM/thb_peem_t3_magQ"; label="Electron")
    ];
    ylabel=Temp_ylabel
)

tvars_themis = [
    tnorm_combine ∘ SpeasyProduct("THB_L2_FGM/thb_fgs_gseQ"; ylabel=B_ylabel, labels=B_labels),
    ["THB_L2_MOM/thb_peim_densityQ", "THB_L2_MOM/thb_peem_densityQ"],
    SpeasyProduct("THB_L2_MOM/thb_peim_velocity_gseQ"; ylabel=V_ylabel, labels=V_labels),
    thm_temp,
]
```

```{julia}
f = Figure(; size=(1200, 800))
add_title = false
legend = (; position=Top())
# plot = (; resample=(; n=Inf))
labels = '1':'9'
tplot(f[1, 1], tvars_psp, tmin_psp, tmax_psp; add_title, legend)
add_labels!(f[1, 1]; labels, open="(a.")

# tplot(f[1, 2], tvars_wind, tmin_wind, tmax_wind; add_title, legend)
# add_labels!(f[1, 2]; labels, open="(b.")

# tplot(f[1, 3], tvars_themis, tmin_wind, tmax_wind; add_title, legend)
# add_labels!(f[1, 3]; labels, open="(c.")
f
```

## Event example (with pressure anisotropy)

```{julia}
using Discontinuity

tau = Second(30)
psp_events = detect_variance(psp_B(tmin_psp, tmax_psp), tau)
```

```{julia}
function plot_candidate(event, ts)
    tplot(ts, event["tstart"], event["tstop"])
end

psp_B_mva = set(mva ∘ psp_B; name="mva_B", labels=["B_L", "B_M", "B_N"])
psp_V_mva = Product((psp_V, psp_B), mva_transform; ylabel=V_ylabel, labels=mva_V_labels)
psp_eTemp_ani = Product(read_electron_temperature(), tview; labels=["Electron (parallel)", "Electron (perpendicular)"])
psp_pTemp_ani = Product(read_proton_temperature(), tview; labels=["Proton (parallel)", "Proton (perpendicular)"])
psp_Temp_ani = [psp_eTemp_ani, psp_pTemp_ani]

event = psp_events[2, :]
plot_candidate(event, [tvars_psp; [psp_B_mva, psp_V_mva, psp_Temp_ani]])
```

### Plot

```{julia}
wind_proton_T3 = SPEDAS.DataSet("Thermal speed",
    ["WI_H1_SWE/Proton_Wperp_nonlin", "WI_H1_SWE/Proton_Wpar_nonlin", "WI_H1_SWE/Proton_Wperp_moment", "WI_H1_SWE/Proton_Wpar_moment"]
)

tvars_wind2 = tvars_wind + [
    wind_proton_T3,
    "WI_ELM2_3DP/MAGT3"
]

tvars_themis2 = tvars_themis + [
    # SpeasyProduct("THB_L2_MOM/thb_peim_t3_magQ"; yscale=identity),
    SpeasyProduct("THB_L2_MOM/thb_peem_t3_magQ"; yscale=identity),
]
```


```{julia}